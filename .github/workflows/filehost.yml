name: Deploy CloverOS static content

on:
  push:
    branches: ["main"]
  workflow_dispatch:

permissions:
  contents: read
  pages: write
  id-token: write

concurrency:
  group: "pages"
  cancel-in-progress: false

jobs:
  deploy:
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Generate dark-mode index and files.manifest
        shell: bash
        run: |
          set -e
          echo "Generating index.html and files.manifest..."

          INDEX_FILE="index.html"
          MANIFEST_FILE="files.manifest"

          # Start index.html
          cat > "$INDEX_FILE" << 'EOF'
<!DOCTYPE html>
<html>
<head>
<meta charset='utf-8'>
<title>Index of CloverOS</title>
<style>
body { background:#0d1117; color:#c9d1d9; font-family: monospace; padding:20px; }
a { color:#58a6ff; text-decoration:none; }
a:hover { text-decoration:underline; }
h1 { color:#58a6ff; }
hr { border:0; border-top:1px solid #30363d; }
pre { line-height:1.6; }
</style>
</head>
<body>
<h1>Index of CloverOS</h1>
<hr>
<pre>
EOF

          # Clear/create files.manifest
          > "$MANIFEST_FILE"

          # Iterate over all files except .git, .github, and index/workflow files
          find . -type f \
            ! -path "./.git/*" \
            ! -path "./.github/*" \
            ! -name "index.html" \
            ! -name "*.yml" \
            | sort | while read -r file; do
            path=$(echo "$file" | sed 's|^\./||')
            echo "Adding $path"

            # Add to index.html
            echo "<a href=\"$path\">$path</a>" >> "$INDEX_FILE"

            # Add to files.manifest
            echo "$path" >> "$MANIFEST_FILE"

            # Optional: create safe extensionless redirect
            base="${path%.*}"
            if [ ! -e "$base" ]; then
              mkdir -p "$base"
              echo "<!DOCTYPE html><html><head><meta http-equiv='refresh' content='0; url=../$path'></head><body></body></html>" > "$base/index.html"
            fi
          done

          # Close index.html
          cat >> "$INDEX_FILE" << 'EOF'
</pre>
<hr>
<footer>Generated automatically for CloverOS â€” Dark Mode Enabled</footer>
</body>
</html>
EOF

          echo "index.html and files.manifest generated successfully."
          echo "---- files.manifest contents ----"
          cat "$MANIFEST_FILE"
          echo "--------------------------------"

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: '.'  # Include all generated files including files.manifest

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
